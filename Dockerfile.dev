FROM rust:1.85-bookworm

# System packages (clang needed for ring crate)
RUN apt update && apt install -y \
    pkg-config \
    libssl-dev \
    postgresql-client \
    clang \
    lld \
    && rm -rf /var/lib/apt/lists/*

# Rust Nightly with WASM target
RUN rustup default nightly
RUN rustup target add wasm32-unknown-unknown

# Install trunk (for CSR frontend) and sqlx-cli
RUN cargo install trunk --locked
RUN cargo install sqlx-cli --no-default-features --features postgres --locked

WORKDIR /workspace

# Default command
CMD ["trunk", "serve", "--address", "0.0.0.0"]
